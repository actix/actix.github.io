<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=https://actix.rs/css/bootstrap-reboot.css><link rel=stylesheet href=https://actix.rs/css/bootstrap.css><link rel=stylesheet href=https://actix.rs/css/font-awesome.min.css><link rel=stylesheet href=https://actix.rs/css/actix.css><link rel=stylesheet href=https://actix.rs/css/highlight.css><link rel=icon href=https://actix.rs/favicon.ico title=actix><title>Databases</title></head><body><header class="navbar navbar-light navbar-toggleable-md bd-navbar"><nav class=actix-main-nav><div class="d-flex justify-content-between hidden-lg-up"><a href=https://actix.rs/ class=navbar-brand><img src=https://actix.rs/img/logo-nav.png class=align-middle alt></a>
<button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#actix-main-nav aria-label="Toggle navigation" aria-controls=actix-main-nav aria-expanded=false>
<span class=navbar-toggler-icon></span></button></div><div class="navbar-collapse collapse" id=actix-main-nav><ul class="nav navbar-nav"><li class="nav-item hd-lg-down"><a class=navbar-brand href=https://actix.rs/><img src=https://actix.rs/img/logo-nav.png class=align-middle alt></a></li><li class=nav-item><a class=nav-link href=https://actix.rs/>Home</a></li><li class=nav-item><a class=nav-link href=https://actix.rs/docs/>Documentation</a></li><li class=nav-item><a class=nav-link href=https://actix.rs/community/>Community</a></li><li class=nav-item><a class=nav-link href=https://actix.rs/code/>Code</a></li></ul></div></nav></header><div class=actix-pageheader><div class=container><h1 class=display-4>Databases</h1></div></div><div class="container actix-docs"><div class=row><div class=col-md-3><button class="btn doctoggle" type=button data-toggle=collapse data-target=#collapsing-docnav aria-expanded=false aria-controls=collapsing-docnav>
Toggle navigation</button><nav class="leftnav collapse show" id=collapsing-docnav><div><h5>Introduction</h5><div><ul class=nav><li><a href=https://actix.rs/docs/>Welcome</a></li><li><a href=https://actix.rs/docs/whatis/>What is Actix</a></li></ul></div><h5>Basics</h5><div><ul class=nav><li><a href=https://actix.rs/docs/getting-started/>Getting Started</a></li><li><a href=https://actix.rs/docs/application/>Application</a></li><li><a href=https://actix.rs/docs/server/>Server</a></li><li><a href=https://actix.rs/docs/handlers/>Handlers</a></li><li><a href=https://actix.rs/docs/extractors/>Extractors</a></li></ul></div><h5>Advanced</h5><div><ul class=nav><li><a href=https://actix.rs/docs/errors/>Errors</a></li><li><a href=https://actix.rs/docs/url-dispatch/>URL Dispatch</a></li><li><a href=https://actix.rs/docs/request/>Requests</a></li><li><a href=https://actix.rs/docs/response/>Responses</a></li><li><a href=https://actix.rs/docs/testing/>Testing</a></li><li><a href=https://actix.rs/docs/middleware/>Middleware</a></li><li><a href=https://actix.rs/docs/static-files/>Static Files</a></li></ul></div><h5>Protocols</h5><div><ul class=nav><li><a href=https://actix.rs/docs/websockets/>Websockets</a></li><li><a href=https://actix.rs/docs/http2/>HTTP/2</a></li></ul></div><h5>Patterns</h5><div><ul class=nav><li><a href=https://actix.rs/docs/autoreload/>Auto-Reloading</a></li><li class=active><a href=https://actix.rs/docs/databases/>Databases</a></li></ul></div><h5>Diagrams</h5><div><ul class=nav><li><a href=https://actix.rs/docs/http_server_init/>HTTP Server Initialization</a></li><li><a href=https://actix.rs/docs/conn_lifecycle/>Connection Lifecycle</a></li></ul></div><h5>API Documentation</h5><div><ul class=nav><li><a href=https://docs.rs/actix target=view_window>actix <span class="fa fa-external-link"></span></a></li><li><a href=https://docs.rs/actix-web/ target=view_window>actix-web <span class="fa fa-external-link"></span></a></li></ul></div></div></nav></div><div class=col-md-9><div class=actix-content><h1 id=async-options>Async Options</h1><p>We have several example projects showing use of async database adapters:</p><ul><li>Postgres: <a href=https://github.com/actix/examples/tree/master/databases/postgres>https://github.com/actix/examples/tree/master/databases/postgres</a></li><li>SQLite: <a href=https://github.com/actix/examples/tree/master/databases/sqlite>https://github.com/actix/examples/tree/master/databases/sqlite</a></li><li>MongoDB: <a href=https://github.com/actix/examples/tree/master/databases/mongodb>https://github.com/actix/examples/tree/master/databases/mongodb</a></li></ul><h1 id=diesel>Diesel</h1><p>The current version of Diesel (v1) does not support asynchronous operations, so it is important to
use the <a href=https://docs.rs/actix-web/3/actix_web/web/fn.block.html><code>web::block</code></a> function to offload your database operations to the Actix runtime
thread-pool.</p><p>You can create action functions that correspond to all the operations your app will perform on the
database.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>fn</span> <span class=nf>insert_new_user</span><span class=p>(</span><span class=n>db</span>: <span class=kp>&amp;</span><span class=nc>SqliteConnection</span><span class=p>,</span><span class=w> </span><span class=n>user</span>: <span class=nc>CreateUser</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>User</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=bp>self</span>::<span class=n>schema</span>::<span class=n>users</span>::<span class=n>dsl</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c1>// Create insertion model
</span><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>uuid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>uuid</span>::<span class=n>Uuid</span>::<span class=n>new_v4</span><span class=p>());</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>new_user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>models</span>::<span class=n>NewUser</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>id</span>: <span class=kp>&amp;</span><span class=nc>uuid</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=n>name</span>: <span class=kp>&amp;</span><span class=nc>user</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c1>// normal diesel operations
</span><span class=c1></span><span class=w>    </span><span class=n>diesel</span>::<span class=n>insert_into</span><span class=p>(</span><span class=n>users</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>values</span><span class=p>(</span><span class=o>&amp;</span><span class=n>new_user</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Error inserting person&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>users</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>filter</span><span class=p>(</span><span class=n>id</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=o>&amp;</span><span class=n>uuid</span><span class=p>))</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>models</span>::<span class=n>User</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Error loading person&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>items</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>())</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>Now you should set up the database pool using a crate such as <code>r2d2</code>, which makes many DB
connections available to your app. This means that multiple handlers can manipulate the DB at the
same time, and still accept new connections. Simply, the pool in your app state. (In this case, it&rsquo;s
beneficial not to use a state wrapper struct because the pool handles shared access for you.)</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>type</span> <span class=nc>DbPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r2d2</span>::<span class=n>Pool</span><span class=o>&lt;</span><span class=n>ConnectionManager</span><span class=o>&lt;</span><span class=n>SqliteConnection</span><span class=o>&gt;&gt;</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=c1>// Create connection pool
</span><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r2d2</span>::<span class=n>Pool</span>::<span class=n>builder</span><span class=p>()</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>build</span><span class=p>(</span><span class=n>manager</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Failed to create pool.&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c1>// Start HTTP server
</span><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>().</span><span class=n>data</span><span class=p>(</span><span class=n>pool</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>resource</span><span class=p>(</span><span class=s>&#34;/{name}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>index</span><span class=p>))</span><span class=w>
</span><span class=w>    </span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>Now, in a request handler, use the <code>Data&lt;T></code> extractor to get the pool from app state and get a
connection from it. This provides an owned database connection that can be passed into a
<a href=https://docs.rs/actix-web/3/actix_web/web/fn.block.html><code>web::block</code></a> closure. Then just call the action function with the necessary arguments
and <code>.await</code> the result.</p><p>This example also maps the error to an <code>HttpResponse</code> before using the <code>?</code> operator but this is not
necessary if your return error type implements <a href=https://docs.rs/actix-web/3/actix_web/trait.ResponseError.html><code>ResponseError</code></a>.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=n>pool</span>: <span class=nc>web</span>::<span class=n>Data</span><span class=o>&lt;</span><span class=n>DbPool</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>name</span>: <span class=nc>web</span>::<span class=n>Path</span><span class=o>&lt;</span><span class=p>(</span><span class=nb>String</span><span class=p>)</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Responder</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>.</span><span class=n>into_inner</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=n>get</span><span class=p>().</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;couldn&#39;t get db connection from pool&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>web</span>::<span class=n>block</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>actions</span>::<span class=n>insert_new_user</span><span class=p>(</span><span class=o>&amp;</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>user</span><span class=p>))</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>map_err</span><span class=p>(</span><span class=o>|</span><span class=n>e</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>eprintln</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=n>HttpResponse</span>::<span class=n>InternalServerError</span><span class=p>().</span><span class=n>finish</span><span class=p>()</span><span class=w>
</span><span class=w>        </span><span class=p>})</span><span class=o>?</span><span class=p>;</span><span class=w>
</span><span class=w>    
</span><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>json</span><span class=p>(</span><span class=n>user</span><span class=p>))</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>That&rsquo;s it! See the full example here:
<a href=https://github.com/actix/examples/tree/master/databases/diesel>https://github.com/actix/examples/tree/master/databases/diesel</a></p><div class=github-edit><a class="fa fa-github" href=https://github.com/actix/actix-website/tree/master/content/docs/databases.md>Edit on GitHub</a></div><div class=actix-next><b>Next up</b>: <a href=/docs/http_server_init/>HTTP Server Initialization</a></div></div></div></div></div><footer class=actix-footer><div class="text-muted actix-footer-gray d-flex justify-content-between"><div class=actix-footer-info>Copyright © 2022 The Actix Team</div><div class=actix-footer-social><a href=https://github.com/actix class=text-muted><i class="fa fa-github" aria-hidden=true></i></a></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script><script src=https://actix.rs/js/bootstrap.min.js></script><script src=https://actix.rs/js/actix.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-110322332-1','auto');ga('send','pageview');}</script></body></html>