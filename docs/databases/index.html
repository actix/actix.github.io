<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=https://actix.rs/css/bootstrap-reboot.css><link rel=stylesheet href=https://actix.rs/css/bootstrap.css><link rel=stylesheet href=https://actix.rs/css/font-awesome.min.css><link rel=stylesheet href=https://actix.rs/css/actix.css><link rel=stylesheet href=https://actix.rs/css/highlight.css><link rel=icon href=https://actix.rs/favicon.ico title=actix><title>Databases</title></head><body><header class="navbar navbar-light navbar-toggleable-md bd-navbar"><nav class=actix-main-nav><div class="d-flex justify-content-between hidden-lg-up"><a href=https://actix.rs/ class=navbar-brand><img src=https://actix.rs/img/logo-nav.png class=align-middle alt></a>
<button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#actix-main-nav aria-label="Toggle navigation" aria-controls=actix-main-nav aria-expanded=false>
<span class=navbar-toggler-icon></span></button></div><div class="navbar-collapse collapse" id=actix-main-nav><ul class="nav navbar-nav"><li class="nav-item hd-lg-down"><a class=navbar-brand href=https://actix.rs/><img src=https://actix.rs/img/logo-nav.png class=align-middle alt></a></li><li class=nav-item><a class=nav-link href=https://actix.rs/>Home</a></li><li class=nav-item><a class=nav-link href=https://actix.rs/docs/>Documentation</a></li><li class=nav-item><a class=nav-link href=https://actix.rs/community/>Community</a></li><li class=nav-item><a class=nav-link href=https://actix.rs/code/>Code</a></li></ul></div></nav></header><div class=actix-pageheader><div class=container><h1 class=display-4>Databases</h1></div></div><div class="container actix-docs"><div class=row><div class=col-md-3><button class="btn doctoggle" type=button data-toggle=collapse data-target=#collapsing-docnav aria-expanded=false aria-controls=collapsing-docnav>
Toggle navigation</button><nav class="leftnav collapse show" id=collapsing-docnav><div><h5>Introduction</h5><div><ul class=nav><li><a href=https://actix.rs/docs/>Welcome</a></li><li><a href=https://actix.rs/docs/whatis/>What is Actix</a></li><li><a href=https://actix.rs/docs/installation/>Installation</a></li></ul></div><h5>Basics</h5><div><ul class=nav><li><a href=https://actix.rs/docs/getting-started/>Getting Started</a></li><li><a href=https://actix.rs/docs/application/>Application</a></li><li><a href=https://actix.rs/docs/server/>Server</a></li><li><a href=https://actix.rs/docs/handlers/>Handlers</a></li><li><a href=https://actix.rs/docs/extractors/>Extractors</a></li></ul></div><h5>Advanced</h5><div><ul class=nav><li><a href=https://actix.rs/docs/errors/>Errors</a></li><li><a href=https://actix.rs/docs/url-dispatch/>URL Dispatch</a></li><li><a href=https://actix.rs/docs/request/>Requests</a></li><li><a href=https://actix.rs/docs/response/>Responses</a></li><li><a href=https://actix.rs/docs/testing/>Testing</a></li><li><a href=https://actix.rs/docs/middleware/>Middlewares</a></li><li><a href=https://actix.rs/docs/static-files/>Static Files</a></li></ul></div><h5>Protocols</h5><div><ul class=nav><li><a href=https://actix.rs/docs/websockets/>Websockets</a></li><li><a href=https://actix.rs/docs/http2/>HTTP/2.0</a></li></ul></div><h5>Patterns</h5><div><ul class=nav><li><a href=https://actix.rs/docs/autoreload/>Autoreloading</a></li><li class=active><a href=https://actix.rs/docs/databases/>Databases</a></li></ul></div><h5>Diagrams</h5><div><ul class=nav><li><a href=https://actix.rs/docs/http_server_init/>Http Server Initialization</a></li><li><a href=https://actix.rs/docs/conn_lifecycle/>Connection Lifecycle</a></li></ul></div><h5>API Documentation</h5><div><ul class=nav><li><a href=https://docs.rs/actix target=view_window>actix <span class="fa fa-external-link"></span></a></li><li><a href=https://docs.rs/actix-web/ target=view_window>actix-web <span class="fa fa-external-link"></span></a></li></ul></div></div></nav></div><div class=col-md-9><div class=actix-content><h1 id=diesel>Diesel</h1><p>At the moment, Diesel 1.0 does not support asynchronous operations,
but it&rsquo;s possible to use the <code>actix</code> synchronous actor system as a database interface api.</p><p>Technically, sync actors are worker style actors. Multiple sync actors
can be run in parallel and process messages from same queue. Sync actors work in mpsc mode.</p><p>Let&rsquo;s create a simple database api that can insert a new user row into a SQLite table.
We must define a sync actor and a connection that this actor will use. The same approach
can be used for other databases.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>actix</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>struct</span> <span class=nc>DbExecutor</span><span class=p>(</span><span class=n>SqliteConnection</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Actor</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>DbExecutor</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>type</span> <span class=nc>Context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SyncContext</span><span class=o>&lt;</span><span class=n>Self</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>This is the definition of our actor. Now, we must define the <em>create user</em> message and response.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>struct</span> <span class=nc>CreateUser</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>CreateUser</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>type</span> <span class=nb>Result</span> <span class=o>=</span><span class=w> </span><span class=nb>Result</span><span class=o>&lt;</span><span class=n>User</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>We can send a <code>CreateUser</code> message to the <code>DbExecutor</code> actor, and as a result, we will receive a
<code>User</code> model instance. Next, we must define the handler implementation for this message.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=k>impl</span><span class=w> </span><span class=n>Handler</span><span class=o>&lt;</span><span class=n>CreateUser</span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>DbExecutor</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=k>type</span> <span class=nb>Result</span> <span class=o>=</span><span class=w> </span><span class=nb>Result</span><span class=o>&lt;</span><span class=n>User</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>fn</span> <span class=nf>handle</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>msg</span>: <span class=nc>CreateUser</span><span class=p>,</span><span class=w> </span><span class=n>_</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Self</span>::<span class=n>Context</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=k>use</span><span class=w> </span><span class=bp>self</span>::<span class=n>schema</span>::<span class=n>users</span>::<span class=n>dsl</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=c1>// Create insertion model
</span><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>uuid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>uuid</span>::<span class=n>Uuid</span>::<span class=n>new_v4</span><span class=p>());</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>new_user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>models</span>::<span class=n>NewUser</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>id</span>: <span class=kp>&amp;</span><span class=nc>uuid</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=n>name</span>: <span class=kp>&amp;</span><span class=nc>msg</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=c1>// normal diesel operations
</span><span class=c1></span><span class=w>        </span><span class=n>diesel</span>::<span class=n>insert_into</span><span class=p>(</span><span class=n>users</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>values</span><span class=p>(</span><span class=o>&amp;</span><span class=n>new_user</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Error inserting person&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>users</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>filter</span><span class=p>(</span><span class=n>id</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=o>&amp;</span><span class=n>uuid</span><span class=p>))</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>load</span>::<span class=o>&lt;</span><span class=n>models</span>::<span class=n>User</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Error loading person&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>items</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>())</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>That&rsquo;s it! Now, we can use the <em>DbExecutor</em> actor from any http handler or middleware.
All we need is to start <em>DbExecutor</em> actors and store the address in a state where http handler
can access it.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=sd>/// This is state where we will store *DbExecutor* address.
</span><span class=sd></span><span class=k>struct</span> <span class=nc>State</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>db</span>: <span class=nc>Addr</span><span class=o>&lt;</span><span class=n>DbExecutor</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>sys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>actix</span>::<span class=n>System</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;diesel-example&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c1>// Start 3 parallel db executors
</span><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SyncArbiter</span>::<span class=n>start</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>DbExecutor</span><span class=p>(</span><span class=n>SqliteConnection</span>::<span class=n>establish</span><span class=p>(</span><span class=s>&#34;test.db&#34;</span><span class=p>).</span><span class=n>unwrap</span><span class=p>())</span><span class=w>
</span><span class=w>    </span><span class=p>});</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c1>// Start http server
</span><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>App</span>::<span class=n>new</span>::<span class=n>data</span><span class=p>(</span><span class=n>State</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>db</span>: <span class=nc>addr</span><span class=p>.</span><span class=n>clone</span><span class=p>()</span><span class=w> </span><span class=p>})</span><span class=w>
</span><span class=w>            </span><span class=p>.</span><span class=n>resource</span><span class=p>(</span><span class=s>&#34;/{name}&#34;</span><span class=p>,</span><span class=w> </span><span class=o>|</span><span class=n>r</span><span class=o>|</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=n>method</span><span class=p>(</span><span class=n>Method</span>::<span class=n>GET</span><span class=p>).</span><span class=n>a</span><span class=p>(</span><span class=n>index</span><span class=p>))</span><span class=w>
</span><span class=w>    </span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8080&#34;</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>start</span><span class=p>()</span><span class=w>
</span><span class=w>    </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;Started http server: 127.0.0.1:8080&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>run</span><span class=p>();</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>We will use the address in a request handler. The handle returns a future object;
thus, we receive the message response asynchronously.
<code>Route::a()</code> must be used for async handler registration.</p><div class=highlight><pre class=chroma><code class=language-rust data-lang=rust><span class=sd>/// Async handler
</span><span class=sd></span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=n>req</span>: <span class=kp>&amp;</span><span class=nc>HttpRequest</span><span class=o>&lt;</span><span class=n>State</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Box</span><span class=o>&lt;</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>req</span><span class=p>.</span><span class=n>match_info</span><span class=p>()[</span><span class=s>&#34;name&#34;</span><span class=p>];</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c1>// Send message to `DbExecutor` actor
</span><span class=c1></span><span class=w>    </span><span class=n>req</span><span class=p>.</span><span class=n>state</span><span class=p>()</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>db</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>CreateUser</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>name</span>: <span class=nc>name</span><span class=p>.</span><span class=n>to_owned</span><span class=p>(),</span><span class=w>
</span><span class=w>        </span><span class=p>})</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>from_err</span><span class=p>()</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>res</span><span class=o>|</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>user</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>json</span><span class=p>(</span><span class=n>user</span><span class=p>)),</span><span class=w>
</span><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=n>InternalServerError</span><span class=p>().</span><span class=n>into</span><span class=p>()),</span><span class=w>
</span><span class=w>        </span><span class=p>})</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>responder</span><span class=p>()</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><blockquote><p>A full example is available in the <a href=https://github.com/actix/examples/tree/master/diesel/>examples directory</a>.</p></blockquote><blockquote><p>More information on sync actors can be found in the
<a href=https://docs.rs/actix/0.7.0/actix/sync/index.html>actix documentation</a>.</p></blockquote><div class=github-edit><a class="fa fa-github" href=https://github.com/actix/actix-website/tree/master/content/docs/databases.md>Edit on GitHub</a></div><div class=actix-next><b>Next up</b>: <a href=/docs/http_server_init/>Http Server Initialization</a></div></div></div></div></div><footer class=actix-footer><div class="text-muted actix-footer-gray d-flex justify-content-between"><div class=actix-footer-info>Copyright © 2020 The Actix Team</div><div class=actix-footer-social><a href=https://github.com/actix class=text-muted><i class="fa fa-github" aria-hidden=true></i></a></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js integrity=sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7 crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js integrity=sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8 crossorigin=anonymous></script><script src=https://actix.rs/js/bootstrap.min.js></script><script src=https://actix.rs/js/actix.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-110322332-1','auto');ga('send','pageview');}</script></body></html>