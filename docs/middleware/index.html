<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="stylesheet" href="https://actix.rs/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="https://actix.rs/css/bootstrap.css">
    <link rel="stylesheet" href="https://actix.rs/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://actix.rs/css/actix.css">
    <link rel="stylesheet" href="https://actix.rs/css/highlight.css">
    <link rel="icon" href="https://actix.rs/favicon.ico" title="actix">

    <title>Middlewares</title>
  </head>
  <body>
    <header class="navbar navbar-light navbar-toggleable-md bd-navbar">
      <nav class="actix-main-nav">
        <div class="d-flex justify-content-between hidden-lg-up">
            <a href="https://actix.rs/" class="navbar-brand">
              <img src="https://actix.rs/img/logo-nav.png" class="align-middle" alt="">
            </a>
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#actix-main-nav" aria-label="Toggle navigation" aria-controls="actix-main-nav" aria-expanded="false">
              <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="navbar-collapse collapse" id="actix-main-nav">
          <ul class="nav navbar-nav">
            <li class="nav-item hd-lg-down">
              <a class="navbar-brand" href="https://actix.rs/"><img src="https://actix.rs/img/logo-nav.png" class="align-middle" alt=""></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://actix.rs/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://actix.rs/docs/">Documentation</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://actix.rs/community/">Community</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://actix.rs/code/">Code</a>
            </li>
            <li class="nav-item language-selector">
              <i class="fa fa-fw fa-globe" aria-hidden="false"></i>
              <ul class="subitem">
              
                <li class="submenu-item"><a href="https://actix.rs/">English</a></li>
              
              <li ><a href="https://ruster-xyz.github.io/server/Actix-web/whatisactix.html">中文</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
    </header>



<div class="actix-pageheader">
  <div class="container">
    <h1 class="display-4">Middlewares</h1>
    
  </div>
</div>

<div class="container actix-docs">
  <div class="row">
    <div class="col-md-3">

      <button class="btn doctoggle" type="button" data-toggle="collapse" data-target="#collapsing-docnav" aria-expanded="false" aria-controls="collapsing-docnav">
        Toggle navigation
      </button>

      <nav class="leftnav collapse show" id="collapsing-docnav">
        <div class="" id="">
          <h5>Introduction</h5>
          <div>
            <ul class="nav">
              
              <li>
                <a href="https://actix.rs/docs/">Welcome</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/whatis/">What is Actix</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/installation/">Installation</a>
              </li>
              
            </ul>
          </div>

          <h5>Basics</h5>
          <div>
            <ul class="nav">
              
              <li>
                <a href="https://actix.rs/docs/getting-started/">Getting Started</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/application/">Application</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/server/">Server</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/handlers/">Handlers</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/extractors/">Extractors</a>
              </li>
              
            </ul>
          </div>

          <h5>Advanced</h5>
          <div>
            <ul class="nav">
              
              <li>
                <a href="https://actix.rs/docs/errors/">Errors</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/url-dispatch/">URL Dispatch</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/request/">Requests</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/response/">Responses</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/testing/">Testing</a>
              </li>
              
              <li class="active">
                <a href="https://actix.rs/docs/middleware/">Middlewares</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/static-files/">Static Files</a>
              </li>
              
            </ul>
          </div>

          <h5>Protocols</h5>
          <div>
            <ul class="nav">
              
              <li>
                <a href="https://actix.rs/docs/websockets/">Websockets</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/http2/">HTTP/2.0</a>
              </li>
              
            </ul>
          </div>

          <h5>Patterns</h5>
          <div>
            <ul class="nav">
              
              <li>
                <a href="https://actix.rs/docs/autoreload/">Autoreloading</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/databases/">Databases</a>
              </li>
              
              <li>
                <a href="https://actix.rs/docs/sentry/">Sentry</a>
              </li>
              
            </ul>
          </div>

          <h5>API Documentation</h5>
          <div>
            <ul class="nav">
              <li><a href="https://docs.rs/actix" target="view_window">actix <span class="fa fa-external-link"></span></a></li>
              <li><a href="https://actix.rs/api/actix-web/stable/actix_web/" target="view_window">actix-web <span class="fa fa-external-link"></span></a></li>
            </ul>
          </div>
        </div>
      </nav>

    </div>
    <div class="col-md-9">
      <div class="actix-content">
        
  

<h1 id="middleware">Middleware</h1>

<p>Actix&rsquo;s middleware system allows us to add additional behavior to request/response processing.
Middleware can hook into an incoming request process, enabling us to modify requests
as well as halt request processing to return a response early.</p>

<p>Middleware can also hook into response processing.</p>

<p>Typically, middleware is involved in the following actions:</p>

<ul>
<li>Pre-process the Request</li>
<li>Post-process a Response</li>
<li>Modify application state</li>
<li>Access external services (redis, logging, sessions)</li>
</ul>

<p>Middleware is registered for each application and executed in same order as
registration. In general, a <em>middleware</em> is a type that implements the
<a href="../../actix-web/actix_web/middleware/trait.Middleware.html"><em>Middleware trait</em></a>.
Each method in this trait has a default implementation. Each method can return
a result immediately or a <em>future</em> object.</p>

<p>The following demonstrates using middleware to add request and response headers:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">use</span><span class="w"> </span><span class="n">http</span>::<span class="p">{</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">HttpTryFrom</span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="p">{</span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">HttpRequest</span><span class="p">,</span><span class="w"> </span><span class="n">HttpResponse</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="n">middleware</span>::<span class="p">{</span><span class="n">Middleware</span><span class="p">,</span><span class="w"> </span><span class="n">Started</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">struct</span> <span class="nc">Headers</span><span class="p">;</span><span class="w">  </span><span class="c1">// &lt;- Our middleware
</span><span class="c1"></span><span class="w">
</span><span class="w"></span><span class="sd">/// Middleware implementation, middlewares are generic over application state,
</span><span class="sd">/// so you can access state with `HttpRequest::state()` method.
</span><span class="sd"></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Middleware</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Headers</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Method is called when request is ready. It may return
</span><span class="sd"></span><span class="w">    </span><span class="sd">/// future, which should resolve before next middleware get called.
</span><span class="sd"></span><span class="w">    </span><span class="k">fn</span> <span class="nf">start</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="kp">&amp;</span><span class="nc">HttpRequest</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Started</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Started</span>::<span class="n">Done</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="sd">/// Method is called when handler returns response,
</span><span class="sd"></span><span class="w">    </span><span class="sd">/// but before sending http message to peer.
</span><span class="sd"></span><span class="w">    </span><span class="k">fn</span> <span class="nf">response</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="kp">&amp;</span><span class="nc">HttpRequest</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">resp</span>: <span class="nc">HttpResponse</span><span class="p">)</span><span class="w">
</span><span class="w">        </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w">
</span><span class="w">    </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">resp</span><span class="p">.</span><span class="n">headers_mut</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="w">
</span><span class="w">            </span><span class="n">header</span>::<span class="n">HeaderName</span>::<span class="n">try_from</span><span class="p">(</span><span class="s">&#34;X-VERSION&#34;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="n">header</span>::<span class="n">HeaderValue</span>::<span class="n">from_static</span><span class="p">(</span><span class="s">&#34;0.2&#34;</span><span class="p">));</span><span class="w">
</span><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">Done</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">App</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="w">       </span><span class="c1">// Register middleware, this method can be called multiple times
</span><span class="c1"></span><span class="w">       </span><span class="p">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">Headers</span><span class="p">)</span><span class="w">
</span><span class="w">       </span><span class="p">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">f</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">HttpResponse</span>::<span class="nb">Ok</span><span class="p">()));</span><span class="w">
</span><span class="w"></span><span class="p">}</span></code></pre></div>
<blockquote>
<p>Actix provides several useful middlewares, such as <em>logging</em>, <em>user sessions</em>, etc.</p>
</blockquote>

<h1 id="logging">Logging</h1>

<p>Logging is implemented as a middleware.
It is common to register a logging middleware as the first middleware for the application.
Logging middleware must be registered for each application.</p>

<p>The <code>Logger</code> middleware uses the standard log crate to log information. You should enable logger
for <em>actix_web</em> package to see access log (<a href="https://docs.rs/env_logger/*/env_logger/">env_logger</a>
or similar).</p>

<h2 id="usage">Usage</h2>

<p>Create <code>Logger</code> middleware with the specified <code>format</code>.
Default <code>Logger</code> can be created with <code>default</code> method, it uses the default format:</p>
<div class="highlight"><pre class="chroma"><code class="language-ignore" data-lang="ignore">  %a %t &#34;%r&#34; %s %b &#34;%{Referer}i&#34; &#34;%{User-Agent}i&#34; %T</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">env_logger</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="n">App</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="n">middleware</span>::<span class="n">Logger</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&#34;RUST_LOG&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;actix_web=info&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">env_logger</span>::<span class="n">init</span><span class="p">();</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="n">App</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="w">       </span><span class="p">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">Logger</span>::<span class="n">default</span><span class="p">())</span><span class="w">
</span><span class="w">       </span><span class="p">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">Logger</span>::<span class="n">new</span><span class="p">(</span><span class="s">&#34;%a %{User-Agent}i&#34;</span><span class="p">))</span><span class="w">
</span><span class="w">       </span><span class="p">.</span><span class="n">finish</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="p">}</span></code></pre></div>
<p>The following is an example of the default logging format:</p>

<pre><code>INFO:actix_web::middleware::logger: 127.0.0.1:59934 [02/Dec/2017:00:21:43 -0800] &quot;GET / HTTP/1.1&quot; 302 0 &quot;-&quot; &quot;curl/7.54.0&quot; 0.000397
INFO:actix_web::middleware::logger: 127.0.0.1:59947 [02/Dec/2017:00:22:40 -0800] &quot;GET /index.html HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:57.0) Gecko/20100101 Firefox/57.0&quot; 0.000646
</code></pre>

<h2 id="format">Format</h2>

<p><code>%%</code>  The percent sign</p>

<p><code>%a</code>  Remote IP-address (IP-address of proxy if using reverse proxy)</p>

<p><code>%t</code>  Time when the request was started to process</p>

<p><code>%P</code>  The process ID of the child that serviced the request</p>

<p><code>%r</code>  First line of request</p>

<p><code>%s</code>  Response status code</p>

<p><code>%b</code>  Size of response in bytes, including HTTP headers</p>

<p><code>%T</code>  Time taken to serve the request, in seconds with floating fraction in .06f format</p>

<p><code>%D</code>  Time taken to serve the request, in milliseconds</p>

<p><code>%{FOO}i</code>  request.headers[&lsquo;FOO&rsquo;]</p>

<p><code>%{FOO}o</code>  response.headers[&lsquo;FOO&rsquo;]</p>

<p><code>%{FOO}e</code>  os.environ[&lsquo;FOO&rsquo;]</p>

<h2 id="default-headers">Default headers</h2>

<p>To set default response headers, the <code>DefaultHeaders</code> middleware can be used. The
<em>DefaultHeaders</em> middleware does not set the header if response headers already contain
a specified header.</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="p">{</span><span class="n">http</span><span class="p">,</span><span class="w"> </span><span class="n">middleware</span><span class="p">,</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">HttpResponse</span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">App</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">middleware</span><span class="p">(</span><span class="w">
</span><span class="w">            </span><span class="n">middleware</span>::<span class="n">DefaultHeaders</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="w">                </span><span class="p">.</span><span class="n">header</span><span class="p">(</span><span class="s">&#34;X-Version&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;0.2&#34;</span><span class="p">))</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#34;/test&#34;</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">             </span><span class="n">r</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="n">http</span>::<span class="n">Method</span>::<span class="n">GET</span><span class="p">).</span><span class="n">f</span><span class="p">(</span><span class="o">|</span><span class="n">req</span><span class="o">|</span><span class="w"> </span><span class="n">HttpResponse</span>::<span class="nb">Ok</span><span class="p">());</span><span class="w">
</span><span class="w">             </span><span class="n">r</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="n">http</span>::<span class="n">Method</span>::<span class="n">HEAD</span><span class="p">).</span><span class="n">f</span><span class="p">(</span><span class="o">|</span><span class="n">req</span><span class="o">|</span><span class="w"> </span><span class="n">HttpResponse</span>::<span class="n">MethodNotAllowed</span><span class="p">());</span><span class="w">
</span><span class="w">        </span><span class="p">})</span><span class="w">
</span><span class="w">       </span><span class="p">.</span><span class="n">finish</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="p">}</span></code></pre></div>
<h2 id="user-sessions">User sessions</h2>

<p>Actix provides a general solution for session management. The
<a href="../../actix-web/actix_web/middleware/session/struct.SessionStorage.html"><strong>SessionStorage</strong></a> middleware can be
used with different backend types to store session data in different backends.</p>

<blockquote>
<p>By default, only cookie session backend is implemented. Other backend implementations
can be added.</p>
</blockquote>

<p><a href="../../actix-web/actix_web/middleware/session/struct.CookieSessionBackend.html"><strong>CookieSessionBackend</strong></a>
uses cookies as session storage. <code>CookieSessionBackend</code> creates sessions which
are limited to storing fewer than 4000 bytes of data, as the payload must fit into a
single cookie. An internal server error is generated if a session contains more than 4000 bytes.</p>

<p>A cookie may have a security policy of <em>signed</em> or <em>private</em>. Each has a respective <code>CookieSessionBackend</code> constructor.</p>

<p>A <em>signed</em> cookie may be viewed but not modified by the client. A <em>private</em> cookie may neither be viewed nor modified by the client.</p>

<p>The constructors take a key as an argument. This is the private key for cookie session - when this value is changed, all session data is lost.</p>

<p>In general, you create a
<code>SessionStorage</code> middleware and initialize it with specific backend implementation,
such as a <code>CookieSessionBackend</code>. To access session data,
<a href="../../actix-web/actix_web/middleware/session/trait.RequestSession.html#tymethod.session"><em>HttpRequest::session()</em></a>
 must be used. This method returns a
<a href="../../actix-web/actix_web/middleware/session/struct.Session.html"><em>Session</em></a> object, which allows us to get or set
session data.</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="p">{</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">HttpRequest</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="n">middleware</span>::<span class="n">session</span>::<span class="p">{</span><span class="n">RequestSession</span><span class="p">,</span><span class="w"> </span><span class="n">SessionStorage</span><span class="p">,</span><span class="w"> </span><span class="n">CookieSessionBackend</span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">index</span><span class="p">(</span><span class="n">req</span>: <span class="kp">&amp;</span><span class="nc">HttpRequest</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;&amp;</span><span class="nb">&#39;static</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// access session data
</span><span class="c1"></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">session</span><span class="p">().</span><span class="n">get</span>::<span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;counter&#34;</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;SESSION value: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="n">req</span><span class="p">.</span><span class="n">session</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="s">&#34;counter&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">req</span><span class="p">.</span><span class="n">session</span><span class="p">().</span><span class="n">set</span><span class="p">(</span><span class="s">&#34;counter&#34;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="s">&#34;Welcome!&#34;</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actix</span>::<span class="n">System</span>::<span class="n">new</span><span class="p">(</span><span class="s">&#34;basic-example&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">server</span>::<span class="n">new</span><span class="p">(</span><span class="w">
</span><span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="n">App</span>::<span class="n">new</span><span class="p">().</span><span class="n">middleware</span><span class="p">(</span><span class="w">
</span><span class="w">           </span><span class="n">SessionStorage</span>::<span class="n">new</span><span class="p">(</span><span class="w">
</span><span class="w">             </span><span class="n">CookieSessionBackend</span>::<span class="n">signed</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w">
</span><span class="w">                </span><span class="p">.</span><span class="n">secure</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w">
</span><span class="w">            </span><span class="p">)))</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&#34;127.0.0.1:59880&#34;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">start</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="p">}</span></code></pre></div>
<h1 id="error-handlers">Error handlers</h1>

<p><code>ErrorHandlers</code> middleware allows us to provide custom handlers for responses.</p>

<p>You can use the <code>ErrorHandlers::handler()</code> method to register a custom error handler
for a specific status code. You can modify an existing response or create a completly new
one. The error handler can return a response immediately or return a future that resolves
into a response.</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">use</span><span class="w"> </span><span class="n">actix_web</span>::<span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">HttpRequest</span><span class="p">,</span><span class="w"> </span><span class="n">HttpResponse</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">http</span><span class="p">,</span><span class="w"> </span><span class="n">middleware</span>::<span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">middleware</span>::<span class="n">ErrorHandlers</span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">render_500</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">HttpRequest</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span>: <span class="nc">HttpResponse</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resp</span><span class="p">.</span><span class="n">into_builder</span><span class="p">();</span><span class="w">
</span><span class="w">   </span><span class="n">builder</span><span class="p">.</span><span class="n">header</span><span class="p">(</span><span class="n">http</span>::<span class="n">header</span>::<span class="n">CONTENT_TYPE</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;application/json&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">   </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">Done</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">into</span><span class="p">()))</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">App</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">middleware</span><span class="p">(</span><span class="w">
</span><span class="w">            </span><span class="n">ErrorHandlers</span>::<span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="w">                </span><span class="p">.</span><span class="n">handler</span><span class="p">(</span><span class="n">http</span>::<span class="n">StatusCode</span>::<span class="n">INTERNAL_SERVER_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">render_500</span><span class="p">))</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#34;/test&#34;</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">             </span><span class="n">r</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="n">http</span>::<span class="n">Method</span>::<span class="n">GET</span><span class="p">).</span><span class="n">f</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">HttpResponse</span>::<span class="nb">Ok</span><span class="p">());</span><span class="w">
</span><span class="w">             </span><span class="n">r</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="n">http</span>::<span class="n">Method</span>::<span class="n">HEAD</span><span class="p">).</span><span class="n">f</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">HttpResponse</span>::<span class="n">MethodNotAllowed</span><span class="p">());</span><span class="w">
</span><span class="w">        </span><span class="p">})</span><span class="w">
</span><span class="w">        </span><span class="p">.</span><span class="n">finish</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="p">}</span></code></pre></div>

        <div class="github-edit">
            <a class="fa fa-github" href="https://github.com/actix/actix-website/tree/master/content/docs/middleware.md"> Edit on GitHub</a>
        </div>
        
        <div class="actix-next"><b>Next up</b>: <a href = /docs/static-files/>
         Static Files</a></div>
      </div>
    </div>
  </div>
</div>

    <footer class="actix-footer">
      <div class="text-muted actix-footer-gray d-flex justify-content-between">
        <div class="actix-footer-info">
          Copyright © 2018 The Actix Team
        </div>
        <div class="actix-footer-social">
          <a href="https://github.com/actix" class="text-muted"><i class="fa fa-github" aria-hidden="true"></i></a>
        </div>
      </div>
    </footer>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://actix.rs/js/bootstrap.min.js"></script>
    <script src="https://actix.rs/js/actix.js"></script>
    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-110322332-1', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>
